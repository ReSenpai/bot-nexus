## ๐ง Bot Nexus

## ๐ ะะฑัะตะต ะพะฟะธัะฐะฝะธะต

Bot Nexus โ backend-ัะตัะฒะธั, ะบะพัะพััะน ัะฒะปัะตััั ัะตะฝััะฐะปัะฝัะผ ััะฐะฝะธะปะธัะตะผ ะธ ะบะพะพัะดะธะฝะฐัะพัะพะผ ะดะปั ัะบะพัะธััะตะผั Telegram-ะฑะพัะพะฒ.

ะกะตัะฒะธั:
- ััะฐะฝะธั ะธะฝัะพัะผะฐัะธั ะพ ะฟะพะปัะทะพะฒะฐัะตะปัั Telegram
- ะทะฝะฐะตั, ะบะฐะบะธะผะธ ะฑะพัะฐะผะธ ะฟะพะปัะทัะตััั ะบะฐะถะดัะน ะฟะพะปัะทะพะฒะฐัะตะปั
- ััะฐะฝะธั ัะพััะพัะฝะธะต ะธ ะฝะฐัััะพะนะบะธ ะบะฐะถะดะพะณะพ ะฑะพัะฐ ะดะปั ะฟะพะปัะทะพะฒะฐัะตะปั
- ะฒ ะฑัะดััะตะผ โ ะพัะณะฐะฝะธะทัะตั ะฒะทะฐะธะผะพะดะตะนััะฒะธะต ะผะตะถะดั ะฑะพัะฐะผะธ (workflow, ัะพะฑััะธั, ัะฐัะฟะธัะฐะฝะธั)

## ๐ฏ ะฆะตะปะธ ะธ ะฝะต-ัะตะปะธ

### ะฆะตะปะธ
- ะะดะธะฝัะน ะธััะพัะฝะธะบ ะฟัะฐะฒะดั ะพ ะฟะพะปัะทะพะฒะฐัะตะปัั ะธ ะฑะพัะฐั
- ะะพะดะดะตัะถะบะฐ ะฝะตัะบะพะปัะบะธั Telegram-ะฑะพัะพะฒ ะฒ ะพะดะฝะพะน ัะธััะตะผะต
- ะะพัะพะฒะฝะพััั ะบ ัะฐััะธัะตะฝะธั (ะพัะบะตัััะฐัะธั, workflow, ัะพะฑััะธั)
- Production-ready ะฐััะธัะตะบัััะฐ
- ะงััะบะพะต ัะฐะทะดะตะปะตะฝะธะต ะพัะฒะตัััะฒะตะฝะฝะพััะธ

### ะะต-ัะตะปะธ (ะฝะฐ ัะตะบััะตะผ ััะฐะฟะต)
- ะััะผะพะต ะพะฑัะตะฝะธะต ั Telegram API
- ะัะตัะตะดะธ ะธ distributed messaging (Kafka / RabbitMQ)
- ะกะปะพะถะฝัะน UI ะธะปะธ admin-ะฟะฐะฝะตะปั


## ๐งฉ ะะพะผะตะฝะฝัะต ัััะฝะพััะธ

### ๐ค User

Telegram-ะฟะพะปัะทะพะฒะฐัะตะปั.

```
User
- id (UUID, PK)
- telegram_id (i64, UNIQUE)     โ ID ะฟะพะปัะทะพะฒะฐัะตะปั ะฒ Telegram
- username (nullable)            โ @username
- first_name
- last_name (nullable)
- language_code (nullable)
- created_at (TIMESTAMPTZ)
```

### ๐ค Bot

ะะดะธะฝ ะธะท ะฒะฝัััะตะฝะฝะธั Telegram-ะฑะพัะพะฒ ัะธััะตะผั.

```
Bot
- id (UUID, PK)
- code (VARCHAR, UNIQUE)         โ "youtube_downloader", "reminder"
- name
- description (nullable)
- version (VARCHAR)
- is_active (BOOLEAN)
- created_at (TIMESTAMPTZ)
```

### ๐ UserBot (Subscription)

ะกะฒัะทั ะฟะพะปัะทะพะฒะฐัะตะปั ั ะฑะพัะพะผ. **ะะปััะตะฒะฐั ัััะฝะพััั ัะธััะตะผั.**

```
UserBot
- id (UUID, PK)
- user_id (FK โ User)
- bot_id (FK โ Bot)
- installed_at (TIMESTAMPTZ)
- settings (JSONB)               โ ะฝะฐัััะพะนะบะธ (ะบะฐัะตััะฒะพ ะฒะธะดะตะพ, ัะทัะบ...)
- state (JSONB)                  โ ัะพััะพัะฝะธะต (ะฟัะพะณัะตัั, ะบัััะพัั...)
- last_interaction_at (TIMESTAMPTZ)
- UNIQUE(user_id, bot_id)
```

### ๐ Workflow (future)

ะะฟะธัะฐะฝะธะต ััะตะฝะฐัะธั ะฒะทะฐะธะผะพะดะตะนััะฒะธั ะผะตะถะดั ะฑะพัะฐะผะธ.

```
Workflow
- id (UUID)
- user_id (FK โ User)
- status
- definition (JSONB)
- created_at
```

### โฑ Event (future)

ะกะพะฑััะธะต, ะบะพัะพัะพะต ะดะพะปะถะฝะพ ะฑััั ะพะฑัะฐะฑะพัะฐะฝะพ ัะธััะตะผะพะน ะธะปะธ ะฑะพัะพะผ.

```
Event
- id (UUID)
- workflow_id (FK โ Workflow)
- event_type
- payload (JSONB)
- scheduled_at
- processed_at
```


## ๐งฑ ะััะธัะตะบัััะฐ ะฟัะพะตะบัะฐ

```
src/
โโโ lib.rs               โ ะฑะธะฑะปะธะพัะตัะฝัะน ะบัะตะนั (ะฒัะต ะผะพะดัะปะธ)
โโโ main.rs              โ ัะพัะบะฐ ะฒัะพะดะฐ (ะบะพะฝัะธะณ, ะะ, ะทะฐะฟััะบ ัะตัะฒะตัะฐ)
โโโ app.rs               โ ัะฑะพัะบะฐ Router ะธะท ััะฑ-ัะพััะตัะพะฒ
โโโ state.rs             โ AppState (DB pool, ะบะพะฝัะธะณััะฐัะธั)
โโโ errors.rs            โ AppError โ HTTP response
โโโ routes/
โ   โโโ mod.rs
โ   โโโ health.rs        โ GET /health
โ   โโโ users.rs         โ /users/*
โ   โโโ bots.rs          โ /bots/*
โ   โโโ subscriptions.rs โ /subscriptions/*
โโโ handlers/
โ   โโโ mod.rs
โ   โโโ health.rs
โ   โโโ users.rs
โ   โโโ bots.rs
โ   โโโ subscriptions.rs
โโโ services/
โ   โโโ mod.rs
โ   โโโ users.rs
โ   โโโ bots.rs
โ   โโโ subscriptions.rs
โโโ repo/
โ   โโโ mod.rs
โ   โโโ user_repo.rs
โ   โโโ bot_repo.rs
โ   โโโ subscription_repo.rs
โโโ models/
โ   โโโ mod.rs
โ   โโโ user.rs
โ   โโโ bot.rs
โ   โโโ subscription.rs
โโโ dto/
    โโโ mod.rs
    โโโ users.rs
    โโโ bots.rs
    โโโ subscriptions.rs

tests/
โโโ common/mod.rs        โ ะพะฑัะธะต ััะธะปะธัั ะดะปั ัะตััะพะฒ
โโโ health.rs
โโโ users.rs
โโโ bots.rs
โโโ subscriptions.rs
```

## ๐ง ะะฐะทะดะตะปะตะฝะธะต ะพัะฒะตัััะฒะตะฝะฝะพััะธ

| ะกะปะพะน       | ะัะฒะตัััะฒะตะฝะฝะพััั                  |
| ---------- | -------------------------------- |
| routes     | HTTP ะผะตัะพะด + ะฟััั (ััะฑ-ัะพััะตัั)  |
| handlers   | HTTP โ ะฑะธะทะฝะตั-ะปะพะณะธะบะฐ             |
| services   | ะฑะธะทะฝะตั-ะฟัะฐะฒะธะปะฐ                   |
| repo       | SQL-ะทะฐะฟัะพัั ะบ PostgreSQL         |
| models     | ะดะพะผะตะฝะฝะฐั ะผะพะดะตะปั (ะทะตัะบะฐะปะพ ะะ)     |
| dto        | JSON ะฒัะพะด / ะฒััะพะด                |
| state      | ะพะฑัะธะต ะทะฐะฒะธัะธะผะพััะธ (DB, config)   |
| errors     | ะตะดะธะฝัะน error flow                |


## ๐ ะะฒัะพัะธะทะฐัะธั ะธ ะฑะตะทะพะฟะฐัะฝะพััั

**Service Token** โ ะฑะพัั ะฐะฒัะพัะธะทััััั ัะตัะตะท API-ะบะปัั (ะทะฐะณะพะปะพะฒะพะบ `Authorization: Bearer <token>`).
Telegram-ะฟะพะปัะทะพะฒะฐัะตะปะธ ะธะดะตะฝัะธัะธัะธัััััั ะฟะพ `telegram_id` โ ะฑะพั ะฟะตัะตะดะฐัั ะตะณะพ ะฒ ะทะฐะฟัะพัะต.


## ๐ ะัะฝะพะฒะฝัะต ััะตะฝะฐัะธะธ

### ะะพะปัะทะพะฒะฐัะตะปั ะทะฐัะพะดะธั ะฒ Telegram-ะฑะพัะฐ

ะััะพัะฝะธะบ: Telegram โ Bot โ Backend

```
POST /users/from-telegram
Authorization: Bearer <service-token>
```
```json
{
  "telegram_id": 123456,
  "username": "alex",
  "first_name": "Alex",
  "bot_code": "youtube_downloader"
}
```
Backend:
- Upsert User (ัะพะทะดะฐัั ะธะปะธ ะพะฑะฝะพะฒะปัะตั)
- ะะฐัะพะดะธั Bot ะฟะพ `code`
- ะกะพะทะดะฐัั UserBot, ะตัะปะธ ัะฒัะทะธ ะตัั ะฝะตั
- ะะฑะฝะพะฒะปัะตั `last_interaction_at`


### ะะพะปััะตะฝะธะต ะฑะพัะพะฒ ะฟะพะปัะทะพะฒะฐัะตะปั
```
GET /users/{id}/bots
```
ะะพะทะฒัะฐัะฐะตั ัะฟะธัะพะบ ะฑะพัะพะฒ ั ะธั ะฝะฐัััะพะนะบะฐะผะธ ะธ ัะพััะพัะฝะธะตะผ.


### ะะฑะฝะพะฒะปะตะฝะธะต ัะพััะพัะฝะธั/ะฝะฐัััะพะตะบ ะฑะพัะฐ
```
PATCH /subscriptions/{id}/state
PATCH /subscriptions/{id}/settings
```
ะัะฟะพะปัะทัะตััั ะฑะพัะฐะผะธ ะดะปั ัะพััะฐะฝะตะฝะธั ะฟัะพะณัะตััะฐ ะธ ะฝะฐัััะพะตะบ.


## ๐งฐ ะขะตัะฝะพะปะพะณะธะธ

- ๐ Web framework โ **axum**
- โก Async runtime โ **tokio**
- ๐ฆ ะกะตัะธะฐะปะธะทะฐัะธั โ **serde** / **serde_json**
- ๐๏ธ ะะฐะทะฐ ะดะฐะฝะฝัั โ **PostgreSQL** + **sqlx**
- ๐ ะะฒัะพัะธะทะฐัะธั โ **JWT** (service tokens)
- ๐งพ ะะพะฝัะธะณััะฐัะธั โ **dotenvy** (.env)
- ๐ ะะพะณะธัะพะฒะฐะฝะธะต โ **tracing**
- โ ะัะธะฑะบะธ โ ัะฒะพะน `AppError` (**thiserror**)
- ๐งช ะขะตััะธัะพะฒะฐะฝะธะต โ **TDD**, ะธะฝัะตะณัะฐัะธะพะฝะฝัะต ัะตััั ะฒ `tests/`
- ๐ณ ะะฝััะฐััััะบัััะฐ โ Docker, docker-compose (Postgres), sqlx migrate


## ๐ง ะะปััะตะฒะฐั ะธะดะตั ะฐััะธัะตะบัััั

- ะญัะพั ัะตัะฒะธั โ **ะฝะต backend ะดะปั ะฑะพัะฐ**.
- ะญัะพ **backend ะดะปั ัะธััะตะผั ะฑะพัะพะฒ**.
- ะะพัั โ ะบะปะธะตะฝัั.
- ะะพะณะธะบะฐ โ ะทะดะตัั.
- ะัะบะตัััะฐัะธั โ ะทะดะตัั.


## ๐ ะัะพะณัะตัั ัะตะฐะปะธะทะฐัะธะธ

- [x] ะะฝััะฐััััะบัััะฐ (Docker, PostgreSQL, ะผะธะณัะฐัะธะธ)
- [x] ะกะบะตะปะตั ะฟัะพะตะบัะฐ (ัะปะพะธ, lib.rs, app.rs)
- [x] Health check (GET /health + ัะตัั)
- [ ] Service token ะฐะฒัะพัะธะทะฐัะธั (middleware)
- [ ] User CRUD (Telegram-ะฟะพะปัะทะพะฒะฐัะตะปะธ)
- [ ] Bot CRUD (ัะตะตััั ะฑะพัะพะฒ)
- [ ] Subscriptions (ัะฒัะทะบะฐ User โ Bot)
- [ ] POST /users/from-telegram (ะณะปะฐะฒะฝัะน ััะตะฝะฐัะธะน)
- [ ] Workflow / Events (future)